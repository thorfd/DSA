<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Inscritos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Leaflet (para el mapa) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
        // --- Configuración del modo oscuro/claro ---
        // 1. Prioridad: Preferencia guardada por el usuario.
        if (localStorage.theme === 'dark') {
          document.documentElement.classList.add('dark');
        } else if (localStorage.theme === 'light') {
          document.documentElement.classList.remove('dark');
        } else {
        // 2. Si no hay preferencia, se usa la hora del sistema.
          const currentHour = new Date().getHours();
          // Modo oscuro de 7 PM a 6 AM
          if (currentHour >= 19 || currentHour < 7) {
            document.documentElement.classList.add('dark');
          } else {
            document.documentElement.classList.remove('dark');
          }
        }
        
        tailwind.config = {
          darkMode: 'class',
        }
      </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .dark body {
            background-color: #111827;
        }
        .chart-container {
            position: relative;
            height: 350px;
            width: 100%;
        }
        #map {
            height: 350px;
            border-radius: 0.75rem;
        }
        .leaflet-tile-pane {
            filter: brightness(100%);
        }
        .dark .leaflet-tile-pane {
           filter: brightness(80%) invert(100%) grayscale(100%);
        }
        .kpi-card, .chart-card, .filter-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out, background-color 0.3s ease, border-color 0.3s ease;
            background-color: white;
        }
        .dark .kpi-card, .dark .chart-card, .dark .filter-card {
            background-color: #1f2937;
            border: 1px solid #374151;
        }
        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        select[multiple] {
            height: 100px;
        }
        /* Estilos para texto en modo oscuro */
        .dark .text-gray-800 { color: #f9fafb; }
        .dark .text-gray-500 { color: #9ca3af; }
        .dark .text-gray-700 { color: #d1d5db; }
        .dark select, .dark input {
            background-color: #374151;
            color: #f9fafb;
            border-color: #4b5563;
        }
        .loader {
            border: 8px solid #f3f3f3;
            border-radius: 50%;
            border-top: 8px solid #4f46e5;
            width: 60px;
            height: 60px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="loading-container" class="fixed inset-0 bg-gray-100 dark:bg-gray-900 flex flex-col items-center justify-center z-50">
        <div class="loader mb-4"></div>
        <p class="text-lg text-gray-700 dark:text-gray-300">Cargando datos del dashboard...</p>
    </div>

    <div id="app-container" class="max-w-7xl mx-auto opacity-0 transition-opacity duration-500">
        <header class="mb-8 flex flex-col md:flex-row md:justify-between md:items-center gap-4">
            <div>
                <h1 class="text-4xl font-bold text-gray-800">Dashboard de Inscritos</h1>
                <p class="text-gray-500 mt-1">Análisis interactivo de la población estudiantil.</p>
            </div>
            <div class="flex items-center space-x-4 self-end md:self-auto">
                 <button id="last-update-btn" class="text-sm bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 py-2 px-4 rounded-lg flex items-center space-x-2 whitespace-nowrap">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.415L11 9.586V6z" clip-rule="evenodd" /></svg>
                    <span id="update-time">Consultando...</span>
                </button>
                <button id="theme-toggle" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200">
                    <svg id="theme-icon-light" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                    <svg id="theme-icon-dark" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                </button>
            </div>
        </header>

        <main id="dashboard-content">
            <!-- Filtros -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="filter-card p-4 rounded-xl shadow">
                    <label for="campus-filter" class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Campus</label>
                    <select id="campus-filter" multiple class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></select>
                    <p class="text-xs text-gray-500 mt-1">Mantén Ctrl (o Cmd) para seleccionar varios.</p>
                </div>
                <div class="filter-card p-4 rounded-xl shadow">
                    <label for="level-filter" class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Nivel Académico</label>
                    <select id="level-filter" multiple class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></select>
                     <p class="text-xs text-gray-500 mt-1">Mantén Ctrl (o Cmd) para seleccionar varios.</p>
                </div>
                 <div class="filter-card p-4 rounded-xl shadow">
                    <label for="period-filter" class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Periodo</label>
                    <select id="period-filter" multiple class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></select>
                     <p class="text-xs text-gray-500 mt-1">Mantén Ctrl (o Cmd) para seleccionar varios.</p>
                </div>
                 <div class="filter-card p-4 rounded-xl shadow flex items-center justify-center">
                    <button id="reset-filters" class="w-full bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-600 transition">
                        Limpiar Filtros
                    </button>
                </div>
            </div>

            <!-- KPIs -->
            <section class="grid grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
                <div class="kpi-card p-6 rounded-xl shadow">
                    <h3 class="text-gray-500 text-sm font-medium">Total de Inscritos</h3>
                    <p id="kpi-total" class="text-4xl font-bold text-gray-800 mt-1">0</p>
                </div>
                <div class="kpi-card p-6 rounded-xl shadow">
                    <h3 class="text-gray-500 text-sm font-medium">Nuevo Ingreso</h3>
                    <p id="kpi-new" class="text-4xl font-bold text-gray-800 mt-1">0</p>
                </div>
                <div class="kpi-card p-6 rounded-xl shadow">
                    <h3 class="text-gray-500 text-sm font-medium">Reingreso</h3>
                    <p id="kpi-reentry" class="text-4xl font-bold text-gray-800 mt-1">0</p>
                </div>
                <div class="kpi-card p-6 rounded-xl shadow">
                    <h3 class="text-gray-500 text-sm font-medium">% con Beca</h3>
                    <p id="kpi-scholarship" class="text-4xl font-bold text-gray-800 mt-1">0%</p>
                </div>
                <div class="kpi-card p-6 rounded-xl shadow">
                    <h3 class="text-gray-500 text-sm font-medium">Beca Promedio</h3>
                    <p id="kpi-avg-scholarship" class="text-4xl font-bold text-gray-800 mt-1">0%</p>
                </div>
            </section>

            <!-- Gráficas -->
            <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="chart-card p-6 rounded-xl shadow">
                    <h3 class="font-semibold text-lg text-gray-800">Inscritos por Nivel Académico</h3>
                    <div class="chart-container"><canvas id="level-chart"></canvas></div>
                </div>
                <div class="chart-card p-6 rounded-xl shadow">
                    <h3 class="font-semibold text-lg text-gray-800">Inscritos por Campus</h3>
                    <div class="chart-container"><canvas id="campus-chart"></canvas></div>
                </div>
                 <div class="chart-card p-6 rounded-xl shadow lg:col-span-2">
                    <h3 class="font-semibold text-lg text-gray-800">Top 10 Carreras con más Inscritos</h3>
                    <div class="chart-container"><canvas id="major-chart"></canvas></div>
                </div>
                <div class="chart-card p-6 rounded-xl shadow">
                    <h3 class="font-semibold text-lg text-gray-800">Distribución por Género</h3>
                    <div class="chart-container"><canvas id="gender-chart"></canvas></div>
                </div>
                <div class="chart-card p-6 rounded-xl shadow">
                    <h3 class="font-semibold text-lg text-gray-800">Distribución por Tipo de Estudiante</h3>
                    <div class="chart-container"><canvas id="type-chart"></canvas></div>
                </div>
                <!-- Gráficas de Edad -->
                 <div class="chart-card p-6 rounded-xl shadow">
                    <h3 class="font-semibold text-lg text-gray-800">Distribución por Rango de Edad</h3>
                    <div class="chart-container"><canvas id="age-range-chart"></canvas></div>
                </div>
                 <div class="chart-card p-6 rounded-xl shadow">
                    <h3 class="font-semibold text-lg text-gray-800">Distribución por Edad Específica</h3>
                    <div class="chart-container"><canvas id="specific-age-chart"></canvas></div>
                </div>
                <div class="chart-card p-6 rounded-xl shadow">
                    <h3 class="font-semibold text-lg text-gray-800">Distribución de Becas</h3>
                    <div class="chart-container"><canvas id="scholarship-dist-chart"></canvas></div>
                </div>
                 <div class="chart-card p-6 rounded-xl shadow">
                    <h3 class="font-semibold text-lg text-gray-800">Geolocalización de Estudiantes</h3>
                    <div id="map"></div>
                </div>
                 <div class="chart-card p-6 rounded-xl shadow lg:col-span-2">
                    <div class="flex justify-between items-center mb-4">
                         <h3 id="timeline-chart-title" class="font-semibold text-lg text-gray-800">Evolución de Inscripciones</h3>
                         <div>
                            <label for="month-filter" class="text-sm font-medium text-gray-700 mr-2">Filtrar por Mes:</label>
                            <select id="month-filter" class="rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                <option value="all">Todos los Meses</option>
                            </select>
                         </div>
                    </div>
                    <div class="chart-container"><canvas id="timeline-chart"></canvas></div>
                </div>
            </section>
            
            <!-- Sección de Análisis de Bajas -->
            <section class="mt-6">
                <div class="chart-card p-6 rounded-xl shadow">
                    <h3 class="font-semibold text-lg text-gray-800 mb-4">Análisis de Alumnos con Baja Total</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-center border-t border-gray-200 dark:border-gray-700 pt-4">
                        <!-- Columna para el conteo -->
                        <div class="md:col-span-1 flex flex-col items-center justify-center text-center p-4">
                            <p class="text-gray-500 font-medium">Total de Bajas</p>
                            <p id="baja-total-count" class="text-6xl lg:text-7xl font-bold text-red-500">0</p>
                        </div>
                        <!-- Columna para el listado -->
                        <div class="md:col-span-2">
                            <h4 class="font-medium text-gray-700">Matrículas de Alumnos de Baja:</h4>
                            <div id="baja-list" class="mt-2 h-40 overflow-y-auto bg-gray-50 dark:bg-gray-800 p-3 rounded-md space-y-2">
                                <!-- Las matrículas se insertarán aquí dinámicamente -->
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // --- Variables Globales ---
        let originalData = [];
        const charts = {};
        let map;
        let cityLayer;

        // --- Configuración de GitHub ---
        const GITHUB_USER = 'thorfd';
        const GITHUB_REPO = 'InscLG';
        const FILE_PATH = 'Inscritos_LG_ADSD25.csv';
        const DATA_URL = `./${FILE_PATH}?v=${new Date().getTime()}`; 
        const API_URL = `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/commits?path=${FILE_PATH}&page=1&per_page=1`;

        // --- Selectores del DOM ---
        const loadingContainer = document.getElementById('loading-container');
        const appContainer = document.getElementById('app-container');
        const campusFilter = document.getElementById('campus-filter');
        const levelFilter = document.getElementById('level-filter');
        const periodFilter = document.getElementById('period-filter');
        const monthFilter = document.getElementById('month-filter');
        const resetFiltersBtn = document.getElementById('reset-filters');
        const themeToggle = document.getElementById('theme-toggle');
        const themeIconLight = document.getElementById('theme-icon-light');
        const themeIconDark = document.getElementById('theme-icon-dark');
        const updateTimeSpan = document.getElementById('update-time');

        // --- Lógica de Inicialización ---
        document.addEventListener('DOMContentLoaded', () => {
            setupTheme();
            fetchData();
            fetchLastUpdate();
            setupEventListeners();
        });

        function setupTheme() {
            if (document.documentElement.classList.contains('dark')) {
                themeIconLight.classList.remove('hidden');
            } else {
                themeIconDark.classList.remove('hidden');
            }
        }
        
        function setupEventListeners() {
            campusFilter.addEventListener('change', updateDashboard);
            levelFilter.addEventListener('change', updateDashboard);
            periodFilter.addEventListener('change', updateDashboard);
            monthFilter.addEventListener('change', updateDashboard);
            resetFiltersBtn.addEventListener('click', () => {
                Array.from(campusFilter.options).forEach(opt => opt.selected = false);
                Array.from(levelFilter.options).forEach(opt => opt.selected = false);
                Array.from(periodFilter.options).forEach(opt => opt.selected = false);
                monthFilter.value = 'all';
                updateDashboard();
            });
            themeToggle.addEventListener('click', toggleTheme);
        }

        async function fetchData() {
            try {
                const response = await fetch(DATA_URL);
                if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
                const csvText = await response.text();
                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        originalData = results.data;
                        initializeDashboard();
                    },
                    error: (error) => {
                        console.error('Error parsing CSV file:', error);
                        loadingContainer.innerHTML = '<p class="text-red-500">Error al procesar los datos.</p>';
                    }
                });
            } catch (error) {
                console.error('Failed to fetch data:', error);
                loadingContainer.innerHTML = '<p class="text-red-500">No se pudo cargar el archivo de datos desde GitHub.</p>';
            }
        }

        async function fetchLastUpdate() {
            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error('Failed to fetch commit data');
                const data = await response.json();
                if (data && data.length > 0) {
                    const lastCommitDate = new Date(data[0].commit.committer.date);
                    const options = { year: 'numeric', month: 'long', day: 'numeric', hour: 'numeric', minute: 'numeric', hour12: true };
                    updateTimeSpan.textContent = `Actualizado: ${lastCommitDate.toLocaleString('es-ES', options)}`;
                } else {
                    updateTimeSpan.textContent = 'No se pudo obtener la fecha';
                }
            } catch (error) {
                console.error('Error fetching last update:', error);
                updateTimeSpan.textContent = 'Error al consultar fecha';
            }
        }

        function initializeDashboard() {
            populateFilters();
            createCharts();
            initializeMap();
            updateDashboard();
            loadingContainer.style.display = 'none';
            appContainer.style.opacity = 1;
        }
        
        // --- Lógica de Filtros y Actualización ---
        function populateFilters() {
            campusFilter.innerHTML = '';
            levelFilter.innerHTML = '';
            periodFilter.innerHTML = '';

            const campuses = [...new Set(originalData.map(item => item['Campus']))].sort();
            const levels = [...new Set(originalData.map(item => item['Nivel académico']))].sort();
            const periods = [...new Set(originalData.map(item => item['Nombre del periodo']))].sort();
            
            campuses.forEach(c => campusFilter.add(new Option(c, c)));
            levels.forEach(l => levelFilter.add(new Option(l, l)));
            periods.forEach(p => periodFilter.add(new Option(p, p)));
            
            const months = [...new Set(originalData.map(item => {
                const parsedDate = parseCustomDate(item['Fecha de inscripción']);
                return parsedDate ? parsedDate.substring(0, 7) : null;
            }))].filter(m => m).sort();
            
            while (monthFilter.options.length > 1) monthFilter.remove(1);
            months.forEach(m => monthFilter.add(new Option(m, m)));
        }
        
        function getFilteredData() {
            const selectedCampuses = Array.from(campusFilter.selectedOptions).map(opt => opt.value);
            const selectedLevels = Array.from(levelFilter.selectedOptions).map(opt => opt.value);
            const selectedPeriods = Array.from(periodFilter.selectedOptions).map(opt => opt.value);

            return originalData.filter(row => 
                (selectedCampuses.length === 0 || selectedCampuses.includes(row['Campus'])) &&
                (selectedLevels.length === 0 || selectedLevels.includes(row['Nivel académico'])) &&
                (selectedPeriods.length === 0 || selectedPeriods.includes(row['Nombre del periodo']))
            );
        }
        
        function updateDashboard() {
            const data = getFilteredData();
            
            const totalStudents = data.length;
            document.getElementById('kpi-total').textContent = totalStudents.toLocaleString();
            document.getElementById('kpi-new').textContent = data.filter(r => r['Clave tipo estudiante'] === 'Nuevo Ingreso').length.toLocaleString();
            document.getElementById('kpi-reentry').textContent = data.filter(r => r['Clave tipo estudiante'] === 'Reingreso').length.toLocaleString();
            const withScholarship = data.filter(r => parseFloat(r['% Beca']) > 0);
            document.getElementById('kpi-scholarship').textContent = `${totalStudents > 0 ? ((withScholarship.length / totalStudents) * 100).toFixed(1) : 0}%`;
            const totalScholarship = data.reduce((sum, r) => sum + (parseFloat(r['% Beca']) || 0), 0);
            document.getElementById('kpi-avg-scholarship').textContent = `${totalStudents > 0 ? (totalScholarship / totalStudents).toFixed(1) : 0}%`;

            updateChart(charts.level, processDataForChart(data, 'Nivel académico'));
            updateChart(charts.campus, processDataForChart(data, 'Campus'));
            updateChart(charts.major, processDataForChart(data, 'Descripción Código académico', 10));
            updateChart(charts.gender, processDataForChart(data, 'Género'));
            updateChart(charts.type, processDataForChart(data, 'Clave tipo estudiante'));
            updateChart(charts.scholarship, processScholarshipData(data));
            updateChart(charts.ageRange, processAgeRangeData(data));
            updateChart(charts.specificAge, processSpecificAgeData(data));
            updateMap(data);
            updateTimelineChart(data);
            updateBajaAnalysis(data);
        }
        
        function updateBajaAnalysis(data) {
            const bajaCountSpan = document.getElementById('baja-total-count');
            const bajaListDiv = document.getElementById('baja-list');

            const bajas = data.filter(row => row['Estatus alumno periodo'] === 'Baja Total');
            
            bajaCountSpan.textContent = bajas.length;

            bajaListDiv.innerHTML = '';

            if (bajas.length > 0) {
                bajas.forEach(alumno => {
                    const matriculaElement = document.createElement('p');
                    matriculaElement.textContent = alumno['Matrícula'];
                    matriculaElement.className = 'text-sm text-gray-800 dark:text-gray-300 px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded';
                    bajaListDiv.appendChild(matriculaElement);
                });
            } else {
                bajaListDiv.innerHTML = '<p class="text-sm text-gray-500">No hay alumnos con baja total en la selección actual.</p>';
            }
        }

        // --- Funciones de Procesamiento de Datos ---
        function parseCustomDate(dateStr) {
            if (!dateStr || typeof dateStr !== 'string') return null;
            if (/^\d{4}-\d{2}-\d{2}/.test(dateStr)) return dateStr.split(' ')[0];
            const parts = dateStr.split(' ')[0].split('/');
            if (parts.length === 3) {
                const [day, month, year] = parts;
                if (day && month && year && year.length === 4) {
                    return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                }
            }
            return null;
        }
        
        function processDataForChart(data, key, limit = null) {
            const counts = data.reduce((acc, row) => {
                const value = row[key] || 'No especificado';
                acc[value] = (acc[value] || 0) + 1;
                return acc;
            }, {});
            let sorted = Object.entries(counts).sort(([, a], [, b]) => b - a);
            if (limit) sorted = sorted.slice(0, limit);
            return { labels: sorted.map(i => i[0]), data: sorted.map(i => i[1]) };
        }

        function processTimelineData(data, groupBy) {
            const counts = data.reduce((acc, row) => {
                const parsedDate = parseCustomDate(row['Fecha de inscripción']);
                if (parsedDate) {
                    const key = (groupBy === 'month') ? parsedDate.substring(0, 7) : parsedDate;
                    acc[key] = (acc[key] || 0) + 1;
                }
                return acc;
            }, {});
            const sorted = Object.entries(counts).sort((a, b) => a[0].localeCompare(b[0]));
            return { labels: sorted.map(i => i[0]), data: sorted.map(i => i[1]) };
        }

        function processScholarshipData(data) {
            const brackets = { '0%': 0, '1-20%': 0, '21-40%': 0, '41-60%': 0, '61-80%': 0, '81-100%': 0 };
            data.forEach(row => {
                const p = parseFloat(row['% Beca']) || 0;
                if (p === 0) brackets['0%']++;
                else if (p <= 20) brackets['1-20%']++;
                else if (p <= 40) brackets['21-40%']++;
                else if (p <= 60) brackets['41-60%']++;
                else if (p <= 80) brackets['61-80%']++;
                else brackets['81-100%']++;
            });
            return { labels: Object.keys(brackets), data: Object.values(brackets) };
        }

        function processAgeRangeData(data) {
            const ranges = { '<=20': 0, '21-25': 0, '26-30': 0, '31-35': 0, '36-40': 0, '>40': 0 };
            data.forEach(row => {
                const age = parseInt(row['Edad'], 10);
                if (!isNaN(age)) {
                    if (age <= 20) ranges['<=20']++;
                    else if (age <= 25) ranges['21-25']++;
                    else if (age <= 30) ranges['26-30']++;
                    else if (age <= 35) ranges['31-35']++;
                    else if (age <= 40) ranges['36-40']++;
                    else ranges['>40']++;
                }
            });
            return { labels: Object.keys(ranges), data: Object.values(ranges) };
        }

        function processSpecificAgeData(data) {
            const counts = data.reduce((acc, row) => {
                const age = row['Edad'];
                if (age && !isNaN(age)) {
                    acc[age] = (acc[age] || 0) + 1;
                }
                return acc;
            }, {});
            const sorted = Object.entries(counts).sort((a, b) => parseInt(a[0]) - parseInt(b[0]));
            return { labels: sorted.map(i => i[0]), data: sorted.map(i => i[1]) };
        }

        // --- Lógica de Gráficas y Mapa ---
        const chartColors = ['#4f46e5', '#ec4899', '#10b981', '#f59e0b', '#3b82f6', '#8b5cf6', '#ef4444', '#6b7280'];
        
        function createCharts() {
            Chart.register(ChartDataLabels);
            Chart.defaults.set('plugins.datalabels', { display: false });

            charts.level = new Chart('level-chart', { type: 'pie', options: getChartOptions({}, 'pie') });
            charts.campus = new Chart('campus-chart', { type: 'doughnut', options: getChartOptions({}, 'doughnut') });
            charts.major = new Chart('major-chart', { type: 'bar', options: getChartOptions({ indexAxis: 'y' }, 'bar') });
            charts.gender = new Chart('gender-chart', { type: 'pie', options: getChartOptions({}, 'pie') });
            charts.type = new Chart('type-chart', { type: 'doughnut', options: getChartOptions({}, 'doughnut') });
            charts.timeline = new Chart('timeline-chart', { type: 'line', options: getChartOptions({ scales: { y: { beginAtZero: true } } }, 'line') });
            charts.scholarship = new Chart('scholarship-dist-chart', { type: 'bar', options: getChartOptions({ scales: { y: { beginAtZero: true } } }, 'bar') });
            
            const ageRangeOptions = getChartOptions({ scales: { y: { beginAtZero: true } } }, 'bar');
            ageRangeOptions.plugins.datalabels = {
                display: true,
                anchor: 'end',
                align: 'top',
                color: document.documentElement.classList.contains('dark') ? '#d1d5db' : '#374151',
                font: { weight: 'bold' }
            };
            charts.ageRange = new Chart('age-range-chart', { type: 'bar', options: ageRangeOptions });
            charts.specificAge = new Chart('specific-age-chart', { type: 'bar', options: getChartOptions({ scales: { y: { beginAtZero: true } } }, 'bar') });
        }

        function getChartOptions(specificOptions = {}, chartType = 'bar') {
            const isDarkMode = document.documentElement.classList.contains('dark');
            const textColor = isDarkMode ? '#d1d5db' : '#374151';
            const gridColor = isDarkMode ? '#4b5563' : '#e5e7eb';

            const baseOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: { color: textColor }
                    }
                },
                scales: {
                    x: { display: true, ticks: { color: textColor }, grid: { color: gridColor } },
                    y: { display: true, ticks: { color: textColor }, grid: { color: gridColor } }
                }
            };
            
            if (chartType === 'pie' || chartType === 'doughnut') {
                baseOptions.scales.x.display = false;
                baseOptions.scales.y.display = false;
            }
            
            if (specificOptions.scales) {
                if (specificOptions.scales.y) Object.assign(baseOptions.scales.y, specificOptions.scales.y);
                if (specificOptions.scales.x) Object.assign(baseOptions.scales.x, specificOptions.scales.x);
            }
            if (specificOptions.indexAxis) baseOptions.indexAxis = specificOptions.indexAxis;

            return baseOptions;
        }

        function updateChart(chart, { labels, data }) {
            chart.data.labels = labels;
            const type = chart.config.type;
            const dataset = { label: 'Inscritos', data, borderWidth: 1 };
            if (type === 'line') {
                dataset.backgroundColor = 'rgba(79, 70, 229, 0.1)';
                dataset.borderColor = '#4f46e5';
                dataset.tension = 0.1;
                dataset.fill = true;
            } else {
                dataset.backgroundColor = chartColors;
                dataset.borderColor = document.documentElement.classList.contains('dark') ? '#1f2937' : '#ffffff';
            }
            chart.data.datasets = [dataset];
            chart.update();
        }
        
        function updateTimelineChart(data) {
            const selectedMonth = monthFilter.value;
            document.getElementById('timeline-chart-title').textContent = selectedMonth === 'all' ? 'Inscripciones Mensuales' : `Inscripciones Diarias para ${selectedMonth}`;
            const chartData = selectedMonth === 'all' ?
                processTimelineData(data, 'month') :
                processTimelineData(data.filter(row => {
                    const parsedDate = parseCustomDate(row['Fecha de inscripción']);
                    return parsedDate && parsedDate.startsWith(selectedMonth);
                }), 'day');
            updateChart(charts.timeline, chartData);
        }

        const cityCoords = {
            'torreon': [25.5428, -103.4068], 'gomez palacio': [25.567, -103.500],
            'lerdo': [25.551, -103.523], 'matamoros': [25.527, -103.228],
            'san pedro': [25.757, -102.980], 'francisco i madero': [25.774, -103.273],
        };

        function initializeMap() {
            map = L.map('map').setView([25.56, -103.45], 10);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            cityLayer = L.layerGroup().addTo(map);
        }

        function updateMap(data) {
            cityLayer.clearLayers();
            const cityCounts = data.reduce((acc, row) => {
                const address = (row['Domicilio estudiante (local)'] || '').toLowerCase();
                let foundCity = 'Otros';
                for (const city in cityCoords) { if (address.includes(city)) { foundCity = city; break; } }
                acc[foundCity] = (acc[foundCity] || 0) + 1;
                return acc;
            }, {});

            const maxCount = Math.max(...Object.values(cityCounts));

            for (const city in cityCounts) {
                if (cityCoords[city]) {
                    const count = cityCounts[city];
                    const radius = count > 0 ? 500 + (count / maxCount) * 10000 : 0;
                    const circle = L.circle(cityCoords[city], {
                        color: '#4f46e5', fillColor: '#4f46e5', fillOpacity: 0.5, radius: radius
                    }).addTo(cityLayer);
                    circle.bindPopup(`<b>${city.charAt(0).toUpperCase() + city.slice(1)}</b><br>${count} inscritos.`);
                }
            }
        }

        // --- Lógica del Tema ---
        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            if (document.documentElement.classList.contains('dark')) {
                localStorage.theme = 'dark';
                themeIconDark.classList.add('hidden');
                themeIconLight.classList.remove('hidden');
            } else {
                localStorage.theme = 'light';
                themeIconLight.classList.add('hidden');
                themeIconDark.classList.remove('hidden');
            }
            // Re-render charts with new theme colors
            const isDarkMode = document.documentElement.classList.contains('dark');
            const newTextColor = isDarkMode ? '#d1d5db' : '#374151';
            const newGridColor = isDarkMode ? '#4b5563' : '#e5e7eb';
            
            Object.values(charts).forEach(chart => {
                chart.options.plugins.legend.labels.color = newTextColor;
                if(chart.options.scales) {
                    if(chart.options.scales.x) {
                        chart.options.scales.x.ticks.color = newTextColor;
                        chart.options.scales.x.grid.color = newGridColor;
                    }
                    if(chart.options.scales.y) {
                         chart.options.scales.y.ticks.color = newTextColor;
                         chart.options.scales.y.grid.color = newGridColor;
                    }
                }
                if(chart.options.plugins.datalabels) {
                    chart.options.plugins.datalabels.color = newTextColor;
                }
                if (chart.config.type !== 'line') {
                    chart.data.datasets[0].borderColor = isDarkMode ? '#1f2937' : '#ffffff';
                }
                chart.update();
            });
        }
    </script>
</body>
</html>
"

