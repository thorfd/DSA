<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tablero de Control Presupuestal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        /* Estilos personalizados para complementar Tailwind CSS */
        body {
            font-family: 'Inter', sans-serif;
        }
        .kpi-card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            transition: transform 0.2s;
        }
        .kpi-card:hover {
            transform: translateY(-5px);
        }
        .filter-select, .month-btn {
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        }
        .month-btn {
            transition: all 0.2s;
        }
        .month-btn.active {
            background-color: #1E40AF; /* blue-800 */
            color: white;
            font-weight: 600;
        }
        /* Estilos para el gráfico de D3 */
        .bar-plan { fill: #60A5FA; } /* blue-400 */
        .bar-real { fill: #F87171; } /* red-400 */
        .axis-label { font-size: 0.8rem; }
        .chart-title { font-size: 1.125rem; font-weight: 600; }
    </style>
     <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <!-- Encabezado -->
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Tablero de Control Presupuestal</h1>
            <p class="text-gray-600 mt-1">Análisis de Gastos: Plan vs. Real</p>
        </header>

        <!-- Indicadores Clave (KPIs) -->
        <section id="kpis" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="kpi-card">
                <h3 class="text-gray-500 font-medium">Gasto Total del Plan</h3>
                <p id="kpi-plan" class="text-3xl font-bold text-blue-600 mt-2">$0.00</p>
            </div>
            <div class="kpi-card">
                <h3 class="text-gray-500 font-medium">Gasto Total Real</h3>
                <p id="kpi-real" class="text-3xl font-bold text-red-600 mt-2">$0.00</p>
            </div>
            <div class="kpi-card">
                <h3 class="text-gray-500 font-medium">Variación ($)</h3>
                <p id="kpi-variance-amount" class="text-3xl font-bold mt-2">$0.00</p>
            </div>
            <div class="kpi-card">
                <h3 class="text-gray-500 font-medium">Variación (%)</h3>
                <p id="kpi-variance-percent" class="text-3xl font-bold mt-2">0.00%</p>
            </div>
        </section>

        <!-- Filtros -->
        <section id="filters" class="bg-white p-4 rounded-lg shadow-md mb-8 space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="ls-filter" class="block text-sm font-medium text-gray-700 mb-1">Línea de Servicio (LS)</label>
                    <select id="ls-filter" class="filter-select w-full p-2 border border-gray-300 bg-white"></select>
                </div>
                <div>
                    <label for="ceco-filter" class="block text-sm font-medium text-gray-700 mb-1">Centro de Costo (CeCo)</label>
                    <select id="ceco-filter" class="filter-select w-full p-2 border border-gray-300 bg-white"></select>
                </div>
            </div>
             <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Mes</label>
                <div id="month-buttons" class="flex flex-wrap gap-2">
                    <!-- Botones de mes se generarán aquí -->
                </div>
            </div>
        </section>

        <!-- Visualizaciones -->
        <main class="grid grid-cols-1 lg:grid-cols-5 gap-8">
            <!-- Gráfico de Barras -->
            <div class="lg:col-span-3 bg-white p-6 rounded-lg shadow-md">
                 <h2 class="chart-title text-gray-900 mb-4">Comparativo Plan vs. Real</h2>
                <div id="chart-container" class="w-full h-96"></div>
            </div>

            <!-- Tabla de Detalle por Concepto -->
            <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                <h2 class="chart-title text-gray-900 mb-4">Detalle por Concepto</h2>
                <div class="overflow-auto h-96">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Concepto</th>
                                <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Real vs Plan</th>
                            </tr>
                        </thead>
                        <tbody id="concepts-table" class="bg-white divide-y divide-gray-200">
                            <!-- Filas de la tabla se generarán aquí -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const lsFilter = d3.select("#ls-filter");
            const cecoFilter = d3.select("#ceco-filter");
            const monthButtonsContainer = d3.select("#month-buttons");

            // Formateadores para moneda y porcentaje
            const formatCurrency = (value) => new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(value);
            const formatPercent = (value) => new Intl.NumberFormat('es-MX', { style: 'percent', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(value);

            // Cargar y procesar los datos del CSV
            d3.csv("Gastos_SV.csv").then(data => {
                // Limpieza y formato de datos
                data.forEach(d => {
                    d.Monto = +d.Monto || 0;
                });

                // Orden cronológico de los meses
                const monthOrder = ['Ago', 'Sep', 'Oct', 'Nov', 'Dic', 'Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul'];

                // Poblar filtros
                const populateFilters = () => {
                    const allLS = ["Todas", ...new Set(data.map(d => d.LS))].sort((a,b) => a.localeCompare(b));
                    lsFilter.selectAll("option").data(allLS).join("option").attr("value", d => d).text(d => d);

                    const allCeCo = ["Todos", ...new Set(data.map(d => d.CeCo))].sort((a,b) => a.localeCompare(b));
                    cecoFilter.selectAll("option").data(allCeCo).join("option").attr("value", d => d).text(d => d);
                    
                    monthButtonsContainer.selectAll("button").data(monthOrder).join("button")
                        .attr("class", (d, i) => `month-btn px-4 py-2 border border-gray-300 text-sm font-medium bg-white hover:bg-gray-50 ${i === 0 ? 'active' : ''}`)
                        .text(d => d)
                        .on("click", function(event, d) {
                            monthButtonsContainer.selectAll("button").classed("active", false);
                            d3.select(this).classed("active", true);
                            updateDashboard();
                        });
                };

                // Función principal para actualizar el dashboard
                const updateDashboard = () => {
                    const selectedLS = lsFilter.property("value");
                    const selectedCeCo = cecoFilter.property("value");
                    const selectedMonth = monthButtonsContainer.select("button.active").text();

                    // Aplicar filtros
                    let filteredData = data.filter(d => {
                        const lsMatch = selectedLS === "Todas" || d.LS === selectedLS;
                        const cecoMatch = selectedCeCo === "Todos" || d.CeCo === selectedCeCo;
                        const monthMatch = d.Mes === selectedMonth;
                        return lsMatch && cecoMatch && monthMatch;
                    });
                    
                    // Calcular KPIs
                    const totalPlan = d3.sum(filteredData.filter(d => d.Escenario === 'Plan Operativo'), d => d.Monto);
                    const totalReal = d3.sum(filteredData.filter(d => d.Escenario === 'Real'), d => d.Monto);
                    const varianceAmount = totalReal - totalPlan;
                    const variancePercent = (totalPlan === 0) ? 0 : varianceAmount / totalPlan;

                    // Actualizar tarjetas de KPI
                    d3.select("#kpi-plan").text(formatCurrency(totalPlan));
                    d3.select("#kpi-real").text(formatCurrency(totalReal));
                    
                    const varianceAmountEl = d3.select("#kpi-variance-amount");
                    varianceAmountEl.text(formatCurrency(varianceAmount))
                        .classed('text-green-600', varianceAmount < 0)
                        .classed('text-red-600', varianceAmount > 0)
                        .classed('text-gray-800', varianceAmount === 0);

                    const variancePercentEl = d3.select("#kpi-variance-percent");
                    variancePercentEl.text(formatPercent(variancePercent))
                       .classed('text-green-600', variancePercent < 0)
                        .classed('text-red-600', variancePercent > 0)
                        .classed('text-gray-800', variancePercent === 0);
                    
                    updateBarChart(totalPlan, totalReal);
                    updateConceptsTable(filteredData);
                };

                // Función para actualizar el gráfico de barras
                const updateBarChart = (plan, real) => {
                    d3.select("#chart-container svg").remove(); // Limpiar gráfico anterior
                    
                    const chartData = [
                        { scenario: 'Plan', value: plan },
                        { scenario: 'Real', value: real }
                    ];

                    const container = d3.select("#chart-container");
                    const margin = { top: 20, right: 30, bottom: 40, left: 90 };
                    const width = container.node().getBoundingClientRect().width - margin.left - margin.right;
                    const height = container.node().getBoundingClientRect().height - margin.top - margin.bottom;

                    const svg = container.append("svg")
                        .attr("width", width + margin.left + margin.right)
                        .attr("height", height + margin.top + margin.bottom)
                        .append("g")
                        .attr("transform", `translate(${margin.left},${margin.top})`);

                    const y = d3.scaleBand()
                        .range([0, height])
                        .domain(chartData.map(d => d.scenario))
                        .padding(0.4);

                    const x = d3.scaleLinear()
                        .domain([0, d3.max(chartData, d => d.value) * 1.1 || 100])
                        .range([0, width]);

                    svg.append("g")
                        .attr("class", "axis-label")
                        .call(d3.axisLeft(y).tickSize(0).tickPadding(10));

                    svg.append("g")
                        .attr("transform", `translate(0,${height})`)
                        .attr("class", "axis-label")
                        .call(d3.axisBottom(x).ticks(5).tickFormat(d => formatCurrency(d).replace('MXN', '')));
                    
                    svg.selectAll("myRect")
                        .data(chartData)
                        .join("rect")
                        .attr("y", d => y(d.scenario))
                        .attr("x", x(0))
                        .attr("width", 0) // Start with 0 width for transition
                        .attr("height", y.bandwidth())
                        .attr("class", d => d.scenario === 'Plan' ? 'bar-plan' : 'bar-real')
                        .transition()
                        .duration(800)
                        .attr("width", d => x(d.value));

                     svg.selectAll("text.bar-label")
                        .data(chartData)
                        .join("text")
                        .attr("class", "bar-label text-sm font-medium")
                        .attr("y", d => y(d.scenario) + y.bandwidth() / 2 + 5)
                        .attr("x", d => x(d.value) + 10)
                        .text(d => formatCurrency(d.value));

                };

                // Función para actualizar la tabla de conceptos
                const updateConceptsTable = (filteredData) => {
                    const conceptsData = d3.rollup(
                        filteredData,
                        v => {
                            const plan = d3.sum(v.filter(d => d.Escenario === 'Plan Operativo'), d => d.Monto);
                            const real = d3.sum(v.filter(d => d.Escenario === 'Real'), d => d.Monto);
                            return { plan, real, variance: real - plan };
                        },
                        d => d.Concepto
                    );

                    const tableData = Array.from(conceptsData, ([key, value]) => ({ concept: key, ...value }))
                        .sort((a, b) => Math.abs(b.variance) - Math.abs(a.variance));

                    const rows = d3.select("#concepts-table").selectAll("tr")
                        .data(tableData, d => d.concept);
                    
                    rows.exit().remove();

                    const newRows = rows.enter().append("tr")
                        .attr("class", "text-sm");

                    newRows.append("td").attr("class", "px-4 py-3 font-medium text-gray-900 whitespace-nowrap").text(d => d.concept);
                    
                    const cell = newRows.append("td").attr("class", "px-4 py-3 text-right");
                    cell.append("div").attr("class", "font-semibold").text(d => formatCurrency(d.real));
                    cell.append("div").attr("class", "text-xs text-gray-500").text(d => `Plan: ${formatCurrency(d.plan)}`);

                    // Update existing rows
                    rows.select("td:nth-child(2) div:first-child").text(d => formatCurrency(d.real));
                    rows.select("td:nth-child(2) div:last-child").text(d => `Plan: ${formatCurrency(d.plan)}`);
                    
                    rows.merge(newRows)
                        .select("td:nth-child(2)")
                        .append("div")
                        .attr("class", d => `text-xs font-bold ${d.variance > 0 ? 'text-red-600' : 'text-green-600'}`)
                        .text(d => `Var: ${formatCurrency(d.variance)}`);
                };

                // Inicializar dashboard
                populateFilters();
                updateDashboard();

                // Agregar listeners para los filtros
                lsFilter.on("change", updateDashboard);
                cecoFilter.on("change", updateDashboard);

            }).catch(error => {
                console.error("Error al cargar o procesar el archivo CSV:", error);
                d3.select("body").html(`<div class="h-screen w-screen flex items-center justify-center bg-red-100 text-red-800 p-8">
                    <div class="text-center">
                        <h1 class="text-2xl font-bold">Error al cargar datos</h1>
                        <p class="mt-2">No se pudo encontrar el archivo <strong>Gastos_SV.csv</strong>. Por favor, asegúrate de que el archivo se encuentre en la misma carpeta que este archivo HTML y que el nombre sea correcto.</p>
                    </div>
                </div>`);
            });
        });
    </script>

</body>
</html>
