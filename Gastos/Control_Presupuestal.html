<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tablero de Control Presupuestal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        /* Estilos personalizados */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F3F4F6; /* gray-100 */
        }
        .kpi-card:hover {
            transform: translateY(-5px);
        }
        .month-btn.active {
            background-color: #1E40AF; /* blue-800 */
            color: white;
            font-weight: 600;
        }
        .bar-plan { fill: #60A5FA; } /* blue-400 */
        .bar-real { fill: #F87171; } /* red-400 */
        
        /* Estilos para select multiple */
        select[multiple] option:checked {
            background: #1E40AF linear-gradient(0deg, #1E40AF 0%, #1E40AF 100%);
            color: white;
        }

        .sortable-header {
            cursor: pointer;
        }
        .sortable-header:hover {
            background-color: #E5E7EB;
        }
    </style>
     <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <!-- Encabezado -->
        <header class="mb-8 flex flex-wrap justify-between items-center gap-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Tablero de Control Presupuestal</h1>
                <p class="text-gray-600 mt-1">Análisis de Gastos: Plan vs. Real</p>
            </div>
            <div id="last-update" class="text-sm text-gray-500 text-right">
                <p>Actualizado: Cargando...</p>
            </div>
        </header>

        <!-- Indicadores Clave (KPIs) -->
        <section id="kpis" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="kpi-card bg-white rounded-lg shadow p-6 transition-transform transform hover:-translate-y-1">
                <h3 class="text-gray-500 font-medium">Gasto Total del Plan</h3>
                <p id="kpi-plan" class="text-3xl font-bold text-blue-600 mt-2">$0.00</p>
            </div>
            <div class="kpi-card bg-white rounded-lg shadow p-6 transition-transform transform hover:-translate-y-1">
                <h3 class="text-gray-500 font-medium">Gasto Total Real</h3>
                <p id="kpi-real" class="text-3xl font-bold text-red-600 mt-2">$0.00</p>
            </div>
            <div class="kpi-card bg-white rounded-lg shadow p-6 transition-transform transform hover:-translate-y-1">
                <h3 class="text-gray-500 font-medium">Variación ($)</h3>
                <p id="kpi-variance-amount" class="text-3xl font-bold mt-2">$0.00</p>
            </div>
            <div class="kpi-card bg-white rounded-lg shadow p-6 transition-transform transform hover:-translate-y-1">
                <h3 class="text-gray-500 font-medium">Variación (%)</h3>
                <p id="kpi-variance-percent" class="text-3xl font-bold mt-2">0.00%</p>
            </div>
        </section>

        <!-- Visualizaciones Principales -->
        <main class="space-y-8">
            <!-- Gráfico de Barras Anual -->
            <div class="chart-card bg-white p-6 rounded-lg shadow-md">
                 <h2 class="chart-title text-xl font-semibold text-gray-900 mb-4">Comparativo Anual por Mes</h2>
                <div id="annual-chart-container" class="w-full h-96"></div>
                <div id="annual-table-container" class="mt-6 overflow-x-auto"></div>
            </div>

            <!-- Sección de Detalle y Filtros -->
            <section class="grid grid-cols-1 lg:grid-cols-4 gap-8">
                <!-- Tabla de Detalle por Concepto -->
                <div class="chart-card bg-white p-6 rounded-lg shadow-md lg:col-span-3">
                    <h2 class="chart-title text-xl font-semibold text-gray-900 mb-4">Detalle por tipo de gasto</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Concepto</th>
                                    <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Plan</th>
                                    <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Real</th>
                                    <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Var. ($)</th>
                                    <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Var. (%)</th>
                                </tr>
                            </thead>
                            <tbody id="concepts-table" class="bg-white divide-y divide-gray-200">
                                <!-- Filas de la tabla se generarán aquí -->
                            </tbody>
                            <tfoot id="concepts-table-footer" class="bg-gray-50 font-bold">
                                <!-- Fila de total se generará aquí -->
                            </tfoot>
                        </table>
                    </div>
                </div>

                 <!-- Filtros -->
                <aside id="filters" class="bg-white p-4 rounded-lg shadow-md lg:col-span-1 space-y-4">
                    <h2 class="text-xl font-semibold text-gray-900 mb-2">Filtros</h2>
                    <div>
                        <label for="ls-filter" class="block text-sm font-medium text-gray-700 mb-1">Línea de Servicio (LS)</label>
                        <select id="ls-filter" multiple class="filter-select w-full p-2 h-32 border border-gray-300 bg-white rounded-md shadow-sm"></select>
                    </div>
                    <div>
                        <label for="ceco-filter" class="block text-sm font-medium text-gray-700 mb-1">Centro de Costo (CeCo)</label>
                        <select id="ceco-filter" multiple class="filter-select w-full p-2 h-32 border border-gray-300 bg-white rounded-md shadow-sm"></select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Mes</label>
                        <div id="month-buttons" class="flex flex-wrap gap-2">
                            <!-- Botones de mes se generarán aquí -->
                        </div>
                    </div>
                    <div class="flex flex-col items-stretch gap-2 pt-2 border-t border-gray-200">
                        <p class="text-xs text-center text-gray-500">
                            Use Ctrl/Cmd + clic para selección múltiple.
                        </p>
                        <button id="reset-ls-ceco" class="px-3 py-1.5 text-xs font-medium text-gray-700 bg-gray-200 hover:bg-gray-300 rounded-md">Resetear LS / CeCo</button>
                        <button id="reset-month" class="px-3 py-1.5 text-xs font-medium text-gray-700 bg-gray-200 hover:bg-gray-300 rounded-md">Resetear Mes</button>
                    </div>
                </aside>
            </section>
            
            <!-- Nueva Sección: Desglose de Gastos -->
            <section id="detail-breakdown" class="chart-card bg-white p-6 rounded-lg shadow-md">
                <h2 class="chart-title text-xl font-semibold text-gray-900 mb-4">Desglose de Gastos</h2>
                <div class="overflow-x-auto">
                    <table class="w-full divide-y divide-gray-200 table-fixed">
                        <thead id="detail-table-header" class="bg-gray-50">
                            <!-- El encabezado se generará dinámicamente -->
                        </thead>
                        <tbody id="detail-table" class="bg-white divide-y divide-gray-200">
                           <!-- Filas de detalle se generarán aquí -->
                        </tbody>
                    </table>
                </div>
            </section>
            
            <!-- Nueva Sección: Top 5 Proveedores -->
            <section id="top-providers" class="chart-card bg-white p-6 rounded-lg shadow-md">
                <h2 class="chart-title text-xl font-semibold text-gray-900 mb-4">Top 5 Proveedores</h2>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="border-b-2 border-gray-200">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Proveedor</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Monto Total</th>
                            </tr>
                        </thead>
                        <tbody id="provider-table" class="divide-y divide-gray-200">
                           <!-- Filas de proveedores se generarán aquí -->
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Elementos del DOM ---
            const lsFilterEl = document.getElementById('ls-filter');
            const cecoFilterEl = document.getElementById('ceco-filter');
            const lastUpdateEl = document.querySelector('#last-update p');
            const resetLsCecoBtn = document.getElementById('reset-ls-ceco');
            const resetMonthBtn = document.getElementById('reset-month');
            
            // --- Lógica de Fecha y Hora de Actualización ---
            const updateFileTimestamp = (dateString) => {
                if (!dateString) {
                    lastUpdateEl.textContent = 'Actualizado: Fecha no disponible';
                    return;
                }
                const fileDate = new Date(dateString);
                const dateOptions = { day: 'numeric', month: 'long', year: 'numeric' };
                const timeOptions = { hour: 'numeric', minute: '2-digit', hour12: true };
                const formattedDate = new Intl.DateTimeFormat('es-MX', dateOptions).format(fileDate);
                const formattedTime = new Intl.DateTimeFormat('es-MX', timeOptions).format(fileDate);
                lastUpdateEl.textContent = `Actualizado: ${formattedDate}, ${formattedTime}`;
            };
            
            // --- Formateadores y Constantes ---
            const formatCurrency = (value) => new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(value);
            const formatPercent = (value) => new Intl.NumberFormat('es-MX', { style: 'percent', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(value);
            
            const formatSiCustom = (n) => {
                if (typeof n !== 'number') return '';
                if (n === 0) return "0";
                const sign = n < 0 ? "-" : "";
                const absN = Math.abs(n);
                if (absN < 1000) return n.toLocaleString('es-MX', {maximumFractionDigits: 0});

                const i = Math.floor(Math.log(absN) / Math.log(1000));
                const suffix = ['','k','M','B','T'][i];
                let val = (absN / Math.pow(1000, i));
                
                let formattedVal = val.toFixed(2);
                if (formattedVal.endsWith('.00')) {
                    formattedVal = formattedVal.slice(0, -3);
                } else if (formattedVal.endsWith('0')) {
                    formattedVal = formattedVal.slice(0, -1);
                }

                return sign + formattedVal + suffix;
            };

            const conceptOrder = [
                "Servicios", "Gastos de Operacion", "Gastos de Viaje", "Software", "Publicidad",
                "Servicios Publicos", "Mantenimiento", "Comunicaciones", "Subcontrataciones",
                "Irrecuperabilidad", "Comisiones Bancarias", "Gastos por Transferencias",
                "Premios", "Materiales", "Bibliografia", "IVA"
            ];
            
            let fullData = [];
            let detailData = [];
            let currentDetailData = [];
            let detailSortState = { key: 'Importe en ML', order: 'desc' };
            let previousLSSelection = ["Todas"];
            let previousCeCoSelection = ["Todos"];

            // --- Carga de Datos y Lógica del Dashboard ---
            const summaryUrl = "Gastos_SV.csv";
            const detailUrl = "DB_Gastos.csv";
            
            Promise.all([
                fetch(summaryUrl, { cache: "no-store" }).then(res => {
                    if (!res.ok) throw new Error(`No se pudo cargar ${summaryUrl}`);
                    updateFileTimestamp(res.headers.get('Last-Modified'));
                    return res.text();
                }).then(text => d3.csvParse(text)),
                fetch(detailUrl, { cache: "no-store" }).then(res => {
                    if (!res.ok) throw new Error(`No se pudo cargar ${detailUrl}`);
                    return res.text();
                }).then(text => d3.csvParse(text))
            ]).then(([summary, detail]) => {
                    fullData = summary;
                    detailData = detail;

                    const lsNumberToNameMap = new Map();
                    fullData.forEach(d => {
                        d.Monto = +d.Monto || 0;
                        const match = d.LS.match(/LS_(\d+)/);
                        if (match && !lsNumberToNameMap.has(match[1])) {
                            lsNumberToNameMap.set(match[1], d.LS);
                        }
                    });

                    const monthLongToShort = {
                        'Enero': 'Ene', 'Febrero': 'Feb', 'Marzo': 'Mar', 'Abril': 'Abr', 
                        'Mayo': 'May', 'Junio': 'Jun', 'Julio': 'Jul', 'Agosto': 'Ago', 
                        'Septiembre': 'Sep', 'Octubre': 'Oct', 'Noviembre': 'Nov', 'Diciembre': 'Dic'
                    };

                    detailData.forEach(d => {
                        d['Importe en ML'] = +d['Importe en ML'] || 0;
                        const cebeStr = String(d.CeBe).trim();
                        if (cebeStr.length > 5) {
                            const lsNumber = cebeStr.substring(3, 5);
                            d.LS = lsNumberToNameMap.get(lsNumber) || 'Desconocida';
                        } else {
                            d.LS = 'Desconocida';
                        }
                        d.MesShort = monthLongToShort[d.Mes] || d.Mes;
                    });
                    
                    const monthOrder = ['Ago', 'Sep', 'Oct', 'Nov', 'Dic', 'Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul'];
                    let allCeCoUnique;
                    
                    const lsFilter = d3.select(lsFilterEl);
                    const cecoFilter = d3.select(cecoFilterEl);
                    const monthButtonsContainer = d3.select("#month-buttons");


                    const populateFilters = () => {
                        const allLS = ["Todas", ...[...new Set(fullData.map(d => d.LS))].sort((a,b) => a.localeCompare(b))];
                        lsFilter.selectAll("option").data(allLS).join("option").attr("value", d => d).text(d => d)
                            .property("selected", d => d === "Todas");

                        allCeCoUnique = ["Todos", ...[...new Set(fullData.map(d => d.CeCo))].sort((a,b) => a.localeCompare(b))];
                        cecoFilter.selectAll("option").data(allCeCoUnique).join("option")
                            .attr("value", d => d)
                            .text(d => d.replace("UF_", ""))
                            .property("selected", d => d === "Todos");

                        const monthMap = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                        const currentMonthName = monthMap[new Date().getMonth()];

                        monthButtonsContainer.selectAll("button").data(monthOrder).join("button")
                            .attr("class", "month-btn px-4 py-2 border border-gray-300 text-sm font-medium bg-white hover:bg-gray-50 rounded-md")
                            .classed("active", d => d === currentMonthName)
                            .text(d => d)
                            .on("click", function(event) {
                                const button = d3.select(this);
                                const isCtrlOrCmd = event.ctrlKey || event.metaKey;
                                if (isCtrlOrCmd) {
                                    button.classed("active", !button.classed("active"));
                                } else {
                                    monthButtonsContainer.selectAll("button").classed("active", false);
                                    button.classed("active", true);
                                }
                                if (monthButtonsContainer.selectAll("button.active").empty()) {
                                    button.classed("active", true);
                                }
                                updateDashboard();
                            });
                        
                        if (monthButtonsContainer.selectAll("button.active").empty()) {
                            monthButtonsContainer.select("button").classed("active", true);
                        }
                    };
                    
                    const updateCeCoFilter = () => {
                        const selectedLS = Array.from(lsFilterEl.selectedOptions).map(o => o.value);
                        let cecosForSelectedLS;
                        if (selectedLS.includes("Todas")) {
                            cecosForSelectedLS = allCeCoUnique;
                        } else {
                            const relevantCeCos = new Set();
                            selectedLS.forEach(ls => {
                                const lsMatch = ls.match(/LS_(\d+)/);
                                if (lsMatch && lsMatch[1]) {
                                    const lsNumber = lsMatch[1];
                                    const cecoPrefix = `UF_569${lsNumber}`;
                                    allCeCoUnique.forEach(ceco => {
                                        if(ceco.startsWith(cecoPrefix)) relevantCeCos.add(ceco);
                                    });
                                }
                            });
                            cecosForSelectedLS = ["Todos", ...Array.from(relevantCeCos).sort()];
                        }
                        const currentCeCoSelection = Array.from(cecoFilterEl.selectedOptions).map(o => o.value);
                        cecoFilter.selectAll("option").data(cecosForSelectedLS, d => d).join("option")
                            .attr("value", d => d)
                            .text(d => d.replace("UF_", ""))
                            .property("selected", d => currentCeCoSelection.includes(d));
                    };

                    window.updateDashboard = () => {
                        const selectedLS = Array.from(lsFilterEl.selectedOptions).map(o => o.value);
                        const selectedCeCo = Array.from(cecoFilterEl.selectedOptions).map(o => o.value);
                        const selectedMonths = d3.selectAll("#month-buttons button.active").nodes().map(n => n.textContent);
                        
                        let monthlyFilteredData = [];
                        let annualFilteredData = [];

                        if (selectedLS.length > 0 && selectedCeCo.length > 0) {
                            annualFilteredData = fullData.filter(d => {
                                const lsMatch = selectedLS.includes("Todas") || selectedLS.includes(d.LS);
                                const cecoMatch = selectedCeCo.includes("Todos") || selectedCeCo.includes(d.CeCo);
                                return lsMatch && cecoMatch;
                            });
                             currentDetailData = detailData.filter(d => {
                                const lsMatch = selectedLS.includes("Todas") || selectedLS.includes(d.LS);
                                if (!lsMatch) return false;
                                
                                const cebeForThisRow = String(d.CeBe).trim();
                                const cecoMatch = selectedCeCo.includes("Todos") || selectedCeCo.some(sel => sel.startsWith("UF_" + cebeForThisRow));
                                return cecoMatch;
                            });

                            if (selectedMonths.length > 0) {
                                monthlyFilteredData = annualFilteredData.filter(d => selectedMonths.includes(d.Mes));
                                currentDetailData = currentDetailData.filter(d => selectedMonths.includes(d.MesShort));
                            }
                        }
                        
                        const totalPlan = d3.sum(monthlyFilteredData.filter(d => d.Escenario === 'Plan Operativo'), d => d.Monto);
                        const totalReal = d3.sum(currentDetailData, d => d['Importe en ML']);
                        const varianceAmount = totalReal - totalPlan;
                        const variancePercent = (totalPlan === 0) ? 0 : varianceAmount / totalPlan;

                        d3.select("#kpi-plan").text(formatCurrency(totalPlan));
                        d3.select("#kpi-real").text(formatCurrency(totalReal));
                        d3.select("#kpi-variance-amount").text(formatCurrency(varianceAmount))
                            .attr('class', 'text-3xl font-bold mt-2')
                            .classed('text-green-600', varianceAmount < 0).classed('text-red-600', varianceAmount > 0);
                        d3.select("#kpi-variance-percent").text(formatPercent(variancePercent))
                            .attr('class', 'text-3xl font-bold mt-2')
                            .classed('text-green-600', variancePercent < 0).classed('text-red-600', variancePercent > 0);
                        
                        updateAnnualChart(annualFilteredData, monthOrder);
                        updateConceptsTable(monthlyFilteredData, currentDetailData);
                        updateDetailTable(currentDetailData);
                        updateProviderTable(currentDetailData);
                    };

                    const updateAnnualChart = (data, monthOrder) => {
                        d3.select("#annual-chart-container svg").remove();
                        d3.select("#annual-table-container table").remove();

                        const monthlyTotals = d3.rollup(data, v => d3.sum(v, d => d.Monto), d => d.Mes, d => d.Escenario);
                        const chartData = monthOrder.map(month => ({ month, plan: monthlyTotals.get(month)?.get('Plan Operativo') || 0, real: monthlyTotals.get(month)?.get('Real') || 0 }));
                        const container = d3.select("#annual-chart-container");
                        if (!container.node() || container.node().getBoundingClientRect().width === 0) return;
                        const margin = { top: 40, right: 20, bottom: 30, left: 80 };
                        const width = container.node().getBoundingClientRect().width - margin.left - margin.right;
                        const height = container.node().getBoundingClientRect().height - margin.top - margin.bottom;
                        const svg = container.append("svg").attr("width", width + margin.left + margin.right).attr("height", height + margin.top + margin.bottom).append("g").attr("transform", `translate(${margin.left},${margin.top})`);
                        const subgroups = ['plan', 'real'];
                        const x0 = d3.scaleBand().domain(monthOrder).range([0, width]).padding(0.2);
                        const x1 = d3.scaleBand().domain(subgroups).range([0, x0.bandwidth()]).padding(0.05);
                        const y = d3.scaleLinear().domain([0, d3.max(chartData, d => Math.max(d.plan, d.real)) * 1.2 || 100]).range([height, 0]);
                        svg.append("g").attr("transform", `translate(0,${height})`).attr("class", "axis-label").call(d3.axisBottom(x0));
                        svg.append("g").attr("class", "axis-label").call(d3.axisLeft(y).tickFormat(d => formatSiCustom(d).replace(/\.00/,'')));
                        const barGroups = svg.append("g").selectAll("g").data(chartData).join("g").attr("transform", d => `translate(${x0(d.month)},0)`);
                        barGroups.selectAll("rect").data(d => subgroups.map(key => ({key, value: d[key]}))).join("rect").attr("x", d => x1(d.key)).attr("y", d => y(d.value)).attr("width", x1.bandwidth()).attr("height", d => height - y(d.value)).attr("class", d => d.key === 'plan' ? 'bar-plan' : 'bar-real');
                        barGroups.selectAll("text.bar-value").data(d => subgroups.map(key => ({key, value: d[key]}))).join("text").attr("class", "bar-value text-xs").attr("x", d => x1(d.key) + x1.bandwidth() / 2).attr("y", d => y(d.value) - 4).attr("text-anchor", "middle").style("fill", "currentColor").text(d => (height - y(d.value)) > 12 ? formatSiCustom(d.value) : "");
                        const legend = svg.append("g").attr("transform", `translate(${width - 120}, -30)`);
                        legend.append("rect").attr("x", 0).attr("width", 12).attr("height", 12).attr("class", "bar-plan");
                        legend.append("text").attr("x", 20).attr("y", 10).text("Plan").attr("class", "legend-text text-sm");
                        legend.append("rect").attr("x", 60).attr("y", 0).attr("width", 12).attr("height", 12).attr("class", "bar-real");
                        legend.append("text").attr("x", 80).attr("y", 10).text("Real").attr("class", "legend-text text-sm");

                        // --- Tabla Anual ---
                        const tableContainer = d3.select("#annual-table-container");
                        const table = tableContainer.append("table").attr("class", "w-full text-sm text-left text-gray-500 dark:text-gray-400");
                        const thead = table.append("thead").attr("class", "text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400");
                        const headerRow = thead.append("tr");
                        ["Mes", "Real", "Plan", "Var. ($)", "Var. (%)"].forEach(header => {
                            headerRow.append("th").attr("scope", "col").attr("class", "px-6 py-3 " + (header !== 'Mes' ? 'text-right' : '')).text(header);
                        });

                        const tbody = table.append("tbody");
                        chartData.forEach(d => {
                            const row = tbody.append("tr").attr("class", "bg-white border-b dark:bg-gray-800 dark:border-gray-700");
                            row.append("th").attr("scope", "row").attr("class", "px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white").text(d.month);
                            row.append("td").attr("class", "px-6 py-4 text-right").text(formatCurrency(d.real));
                            row.append("td").attr("class", "px-6 py-4 text-right").text(formatCurrency(d.plan));
                            row.append("td").attr("class", "px-6 py-4 text-right font-semibold").classed("text-red-600", d.variance > 0).classed("text-green-600", d.variance < 0).text(formatCurrency(d.variance));
                            row.append("td").attr("class", "px-6 py-4 text-right font-semibold").classed("text-red-600", d.variancePercent > 0).classed("text-green-600", d.variancePercent < 0).text(formatPercent(d.variancePercent));
                        });

                        const totalPlan = d3.sum(chartData, d=> d.plan);
                        const totalReal = d3.sum(chartData, d=> d.real);
                        const totalVariance = totalReal - totalPlan;
                        const totalVariancePercent = totalPlan === 0 ? 0 : totalVariance / totalPlan;

                        const tfoot = table.append("tfoot").attr("class", "font-bold bg-gray-50 dark:bg-gray-700");
                        const footerRow = tfoot.append("tr");
                        footerRow.append("th").attr("scope", "row").attr("class", "px-6 py-3 text-base").text("Total");
                        footerRow.append("td").attr("class", "px-6 py-3 text-right").text(formatCurrency(totalReal));
                        footerRow.append("td").attr("class", "px-6 py-3 text-right").text(formatCurrency(totalPlan));
                        footerRow.append("td").attr("class", "px-6 py-3 text-right").classed("text-red-600", totalVariance > 0).classed("text-green-600", totalVariance < 0).text(formatCurrency(totalVariance));
                        footerRow.append("td").attr("class", "px-6 py-3 text-right").classed("text-red-600", totalVariancePercent > 0).classed("text-green-600", totalVariancePercent < 0).text(formatPercent(totalVariancePercent));
                    };

                    const updateConceptsTable = (planData, realData) => {
                        const planConcepts = d3.rollup(planData.filter(d=>d.Escenario === 'Plan Operativo'), v => d3.sum(v, d=>d.Monto), d => d.Concepto);
                        const realConcepts = d3.rollup(realData, v => d3.sum(v, d=>d['Importe en ML']), d => d['Cuenta SV']);

                        const allConcepts = new Set([...planConcepts.keys(), ...realConcepts.keys()]);
                        
                        const tableData = Array.from(allConcepts, concept => {
                            const plan = planConcepts.get(concept) || 0;
                            const real = realConcepts.get(concept) || 0;
                            return {
                                concept,
                                plan,
                                real,
                                variance: real - plan,
                                variancePercent: (plan === 0) ? 0 : (real - plan) / plan
                            }
                        }).sort((a, b) => { const indexA = conceptOrder.indexOf(a.concept); const indexB = conceptOrder.indexOf(b.concept); if (indexA === -1 && indexB === -1) return a.concept.localeCompare(b.concept); if (indexA === -1) return 1; if (indexB === -1) return -1; return indexA - indexB; });
                        
                        const rows = d3.select("#concepts-table").selectAll("tr").data(tableData, d => d.concept);
                        rows.exit().remove();
                        const newRows = rows.enter().append("tr").attr("class", "text-sm");
                        newRows.append("td").attr("class", "px-3 py-2 font-medium text-gray-900 dark:text-white whitespace-nowrap");
                        newRows.append("td").attr("class", "px-3 py-2 text-right text-gray-700 dark:text-gray-300");
                        newRows.append("td").attr("class", "px-3 py-2 text-right text-gray-700 dark:text-gray-300");
                        newRows.append("td").attr("class", "px-3 py-2 text-right font-semibold");
                        newRows.append("td").attr("class", "px-3 py-2 text-right font-semibold");
                        const allRows = newRows.merge(rows);
                        allRows.select("td:nth-child(1)").text(d => d.concept);
                        allRows.select("td:nth-child(2)").text(d => formatCurrency(d.plan));
                        allRows.select("td:nth-child(3)").text(d => formatCurrency(d.real));
                        allRows.select("td:nth-child(4)").text(d => formatCurrency(d.variance)).attr("class", "px-3 py-2 text-right font-semibold").classed("text-red-600", d => d.variance > 0).classed("text-green-600", d => d.variance < 0);
                        allRows.select("td:nth-child(5)").text(d => formatPercent(d.variancePercent)).attr("class", "px-3 py-2 text-right font-semibold").classed("text-red-600", d => d.variancePercent > 0).classed("text-green-600", d => d.variancePercent < 0);
                        const footer = d3.select("#concepts-table-footer");
                        footer.selectAll("tr").remove();
                        if(tableData.length > 0) {
                            const totalPlan = d3.sum(tableData, d => d.plan); const totalReal = d3.sum(tableData, d => d.real); const totalVariance = totalReal - totalPlan; const totalVariancePercent = (totalPlan === 0) ? 0 : totalVariance / totalPlan;
                            const footerRow = footer.append("tr").attr("class", "text-sm border-t-2 border-gray-300 dark:border-gray-600");
                            footerRow.append("td").attr("class", "px-3 py-2 text-left font-bold text-gray-900 dark:text-white").text("Total");
                            footerRow.append("td").attr("class", "px-3 py-2 text-right font-bold text-gray-900 dark:text-white").text(formatCurrency(totalPlan));
                            footerRow.append("td").attr("class", "px-3 py-2 text-right font-bold text-gray-900 dark:text-white").text(formatCurrency(totalReal));
                            footerRow.append("td").attr("class", "px-3 py-2 text-right font-bold").classed("text-red-600", totalVariance > 0).classed("text-green-600", totalVariance < 0).text(formatCurrency(totalVariance));
                            footerRow.append("td").attr("class", "px-3 py-2 text-right font-bold").classed("text-red-600", totalVariancePercent > 0).classed("text-green-600", totalVariancePercent < 0).text(formatPercent(totalVariancePercent));
                        }
                    };
                    
                    const createSortableHeader = () => {
                        const headers = [ { key: 'Cuenta SV', label: 'Concepto Gasto', width: '13%' }, { key: 'Cuenta Contable', label: 'Cta. Contable', width: '20%' }, { key: 'Texto', label: 'Texto', width: '25%' }, { key: 'Oc', label: 'OC', width: '7%' }, { key: 'Proveedor / Usuario', label: 'Proveedor/Usuario', width: '15%' }, { key: 'Importe en ML', label: 'Importe', width: '10%' }, { key: 'Solicitante OC', label: 'Solicitante OC', width: '10%' } ];
                        const headerRow = d3.select("#detail-table-header").selectAll("tr").data([1]).join("tr");
                        headerRow.selectAll("th").data(headers).join("th").attr("class", "px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider sortable-header").style("width", d => d.width).classed("text-right", d => d.key === 'Importe en ML').on("click", (event, d) => { if (detailSortState.key === d.key) { detailSortState.order = detailSortState.order === 'asc' ? 'desc' : 'asc'; } else { detailSortState.key = d.key; detailSortState.order = 'asc'; } updateDetailTable(currentDetailData); }).html(d => { let sortIcon = ''; if (detailSortState.key === d.key) { sortIcon = detailSortState.order === 'asc' ? ' ▲' : ' ▼'; } return d.label + sortIcon; });
                    };

                    const updateDetailTable = (data) => {
                        createSortableHeader();
                        const ivaRows = data.filter(d => d['Cuenta SV'] === 'IVA');
                        let nonIvaRows = data.filter(d => d['Cuenta SV'] !== 'IVA');
                        let finalData = [...nonIvaRows];
                        if (ivaRows.length > 0) {
                            const totalIva = d3.sum(ivaRows, d => d['Importe en ML']);
                            const aggregatedIvaRow = { 'Cuenta SV': 'IVA (Total)', 'Cuenta Contable': '-', 'Texto': `Total de ${ivaRows.length} transacciones de IVA`, 'Oc': '-', 'Proveedor / Usuario': '-', 'Importe en ML': totalIva, 'Solicitante OC': '-', isAggregated: true };
                            finalData.push(aggregatedIvaRow);
                        }
                        finalData.sort((a, b) => { const key = detailSortState.key; let valA = a[key]; let valB = b[key]; const order = detailSortState.order === 'asc' ? 1 : -1; if (typeof valA === 'string' && typeof valB === 'string') { return valA.localeCompare(valB) * order; } return (valA - valB) * order; });
                        const tableBody = d3.select("#detail-table");
                        const rows = tableBody.selectAll("tr").data(finalData, (d,i) => i);
                        rows.exit().remove();
                        const newRows = rows.enter().append("tr").attr("class", "text-sm");
                        newRows.append('td').attr('class', 'px-3 py-2 text-xs text-gray-700 dark:text-gray-300 break-words');
                        newRows.append('td').attr('class', 'px-3 py-2 text-xs text-gray-700 dark:text-gray-300 break-words');
                        newRows.append('td').attr('class', 'px-3 py-2 text-xs text-gray-700 dark:text-gray-300 break-words');
                        newRows.append('td').attr('class', 'px-3 py-2 text-xs text-gray-700 dark:text-gray-300 whitespace-nowrap');
                        newRows.append('td').attr('class', 'px-3 py-2 text-xs text-gray-700 dark:text-gray-300 break-words');
                        newRows.append('td').attr('class', 'px-3 py-2 text-xs text-gray-700 dark:text-gray-300 text-right whitespace-nowrap');
                        newRows.append('td').attr('class', 'px-3 py-2 text-xs text-gray-700 dark:text-gray-300 whitespace-nowrap');

                        const allRows = newRows.merge(rows);
                        allRows.select("td:nth-child(1)").text(d => d['Cuenta SV']);
                        allRows.select("td:nth-child(2)").text(d => d['Cuenta Contable']);
                        allRows.select("td:nth-child(3)").text(d => d.Texto);
                        allRows.select("td:nth-child(4)").text(d => d.Oc);
                        allRows.select("td:nth-child(5)").text(d => d['Proveedor / Usuario']);
                        allRows.select("td:nth-child(6)").text(d => formatCurrency(d['Importe en ML']));
                        allRows.select("td:nth-child(7)").text(d => d['Solicitante OC']);
                    };

                    const updateProviderTable = (data) => {
                        const providerData = data.filter(d => d['Proveedor / Usuario'] && d['Proveedor / Usuario'].toUpperCase().trim() !== 'AMEX');
                        const providerTotals = d3.rollup( providerData, v => d3.sum(v, d => d['Importe en ML']), d => d['Proveedor / Usuario'] );
                        const top5Providers = Array.from(providerTotals, ([provider, amount]) => ({ provider, amount })).sort((a, b) => b.amount - a.amount).slice(0, 5);
                        const tableBody = d3.select("#provider-table");
                        const rows = tableBody.selectAll("tr").data(top5Providers, d => d.provider);
                        rows.exit().remove();
                        const newRows = rows.enter().append("tr").attr("class", "text-sm");
                        newRows.append("td").attr("class", "px-3 py-2 text-gray-700 dark:text-gray-300 whitespace-nowrap");
                        newRows.append("td").attr("class", "px-3 py-2 text-right text-gray-700 dark:text-gray-300 whitespace-nowrap");
                        const allRows = newRows.merge(rows);
                        allRows.select("td:nth-child(1)").text(d => d.provider);
                        allRows.select("td:nth-child(2)").text(d => formatCurrency(d.amount));
                    };

                    const handleMultiSelect = (element, previousSelection, isAllSelector) => {
                        const currentSelection = Array.from(element.selectedOptions).map(o => o.value);
                        const justClickedSet = new Set(currentSelection.filter(x => !previousSelection.includes(x)));
                        if (justClickedSet.has(isAllSelector)) {
                            d3.select(element).selectAll("option").property("selected", d => d === isAllSelector);
                        } else if (currentSelection.length > 1 && currentSelection.includes(isAllSelector)) {
                            d3.select(element).selectAll(`option[value="${isAllSelector}"]`).property("selected", false);
                        }
                        if(currentSelection.length === 0) {
                            d3.select(element).selectAll(`option[value="${isAllSelector}"]`).property("selected", true);
                        }
                        return Array.from(element.selectedOptions).map(o => o.value);
                    };

                    populateFilters();
                    updateDashboard();

                    lsFilter.on("change", () => { 
                        previousLSSelection = handleMultiSelect(lsFilterEl, previousLSSelection, "Todas");
                        cecoFilter.selectAll('option').property('selected', d => d === 'Todos');
                        previousCeCoSelection = ['Todos'];
                        updateCeCoFilter(); 
                        updateDashboard(); 
                    });
                    cecoFilter.on("change", () => {
                        previousCeCoSelection = handleMultiSelect(cecoFilterEl, previousCeCoSelection, "Todos");
                        updateDashboard();
                    });
                     resetLsCecoBtn.addEventListener('click', () => {
                        lsFilter.selectAll("option").property("selected", d => d === "Todas");
                        cecoFilter.selectAll("option").property("selected", d => d === "Todos");
                        previousLSSelection = ["Todas"];
                        previousCeCoSelection = ["Todos"];
                        updateCeCoFilter();
                        updateDashboard();
                    });

                    resetMonthBtn.addEventListener('click', () => {
                        const monthMap = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                        const currentMonthName = monthMap[new Date().getMonth()];
                        monthButtonsContainer.selectAll("button")
                            .classed("active", d => d === currentMonthName);
                        if (monthButtonsContainer.selectAll("button.active").empty()) {
                            monthButtonsContainer.select("button").classed("active", true);
                        }
                        updateDashboard();
                    });
                    window.addEventListener('resize', () => updateDashboard());

                })
                .catch(error => {
                    console.error("Error al cargar o procesar el archivo CSV:", error);
                    d3.select("body").html(`<div class="h-screen w-screen flex items-center justify-center bg-red-100 text-red-800 p-8"><div class="text-center"><h1 class="text-2xl font-bold">Error al cargar datos</h1><p class="mt-2">No se pudieron encontrar los archivos <strong>Gastos_SV.csv</strong> o <strong>DB_Gastos.csv</strong>. Por favor, asegúrate de que ambos archivos se encuentren en la misma carpeta que este archivo HTML y que los nombres sean correctos.</p></div></div>`);
                });
        });
    </script>
</body>
</html>

